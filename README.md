# ComDig-Test-Task

### Тестовое задание:
> Написать sql-скрипт, который пройдет по всем таблицам всей БД и изменит поле row_num с varchar(10) на int4 и сделает его not null. БД - Postgresql.

### Описание решения

Решение разработано для более общего случая: атрибуты могут иметь тип `varchar` произвольной длины, значения атрибутов могут быть засорены посторонними символами, либо значения числа в строке выходит из диапазона значений 4-байтного `int4`. Также имя атрибута, можно задать произвольно.

### Описание работы программы

1. Основная процедура `alter_columns_datatype_by_column_name` принимает на вход значение имени для атрибутов таблиц, тип которых нужно поменять с `varchar` на `int4`
2. В цикле выбираются те пользовательские таблицы, которые имеют атрибут с заданным именем. Наличие искомого атрибута в таблице проверяется с помощью метода `exists_column`
3. Так как некоторые значения нельзя будет перевести в целочисленное значение, то перед изменением типа атрибута в избежании исключений, нужно обработать саму таблицу с помощью динамических запросов DML, в них будет использоваться функция `is_valid_int4_value` возвращающая `TRUE`, если значение состоит исключительно из цифр, а численное значение входит в диапазон `int4`. Нужно определить - как именно будут изменяться значения, есть два варианта:
    + Искомый атрибут является первичным ключом или входит в него, (проверяется с помощью функции `primary_key_columns`). В этом случае, если значение атрибута невалидное (проверяется с помощью вышеописанной функции), строку в таблице удаляем, т.к. при замене на какое-нибудь валидное значение, велика вероятность присвоить уже имеющиееся значения ключа
    + Атрибут не является ключевым. В этом случае невалидное значение, в том числе значение `NULL` менятся на значение по умолчанию (в моем случае присваивается `-1`)
4. С помощью `ALTER TABLE ... ` меняет тип атрибута на `int4`, а затем ставим ограничение `NOT NULL`. Второе ограничение на атрибут, в случае если он является первичным ключом не уставливаем, поскольку первичный ключ поумолчанию содержит это ограничение.


Вызов процедуры с помощью `CALL `, в аргумент процедуры передаем имя атрибута. По условию задачи по умолчанию передается "row_num"
